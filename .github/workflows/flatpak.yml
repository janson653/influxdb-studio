name: Flatpak Build

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  flatpak-build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        gnome-version: ['47', '46', '45', '44']
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install system dependencies
        run: |
          echo "ğŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libwebkit2gtk-4.0-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            flatpak-builder \
            appstream-compose \
            flatpak

      - name: Build Tauri application
        run: |
          echo "ğŸš€ æ„å»º Tauri åº”ç”¨..."
          
          # å®‰è£…å‰ç«¯ä¾èµ–
          pnpm install
          
          # æ„å»ºå‰ç«¯
          pnpm run build
          
          # æ„å»º Tauri åº”ç”¨
          cd src-tauri
          cargo build --release --target x86_64-unknown-linux-gnu
          
          # å¤åˆ¶æ„å»ºäº§ç‰©
          cp target/x86_64-unknown-linux-gnu/release/influxdb-studio ../flatpak/
          cd ..
          
          echo "âœ… Tauri åº”ç”¨æ„å»ºå®Œæˆ"

      - name: Setup Flatpak environment
        run: |
          echo "ğŸ“¦ é…ç½® Flatpak ç¯å¢ƒ..."
          
          # æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
          echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯ï¼š"
          flatpak-builder --version
          flatpak --version
          appstream-compose --version || echo "âš ï¸  appstream-compose ä¸å¯ç”¨"
          
          # ç¡®ä¿ Flatpak æœåŠ¡æ­£åœ¨è¿è¡Œ
          echo "ğŸ”§ å¯åŠ¨ Flatpak æœåŠ¡..."
          sudo systemctl start flatpak-system-helper || true
          
          # æ£€æŸ¥ Flatpak çŠ¶æ€
          echo "ğŸ” æ£€æŸ¥ Flatpak çŠ¶æ€..."
          flatpak --version
          flatpak remote-list || echo "âš ï¸  æ— æ³•åˆ—å‡ºè¿œç¨‹ä»“åº“"
          
          # ä»¥ root æƒé™é…ç½® Flatpak
          echo "ğŸ”§ é…ç½® Flatpak è¿œç¨‹ä»“åº“..."
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak update
          
          # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ GNOME Platform
          echo "ğŸ”§ å®‰è£… GNOME Platform ${{ matrix.gnome-version }}..."
          sudo flatpak install flathub org.gnome.Platform//${{ matrix.gnome-version }} org.gnome.Sdk//${{ matrix.gnome-version }} -y
          
          # éªŒè¯å®‰è£…
          echo "âœ… éªŒè¯ Flatpak ç¯å¢ƒ..."
          flatpak list --app | grep -E "(Platform|Sdk)" || echo "âš ï¸  æœªæ‰¾åˆ°é¢„æœŸçš„è¿è¡Œæ—¶"
          flatpak list --runtime | grep -E "(Platform|Sdk)" || echo "âš ï¸  æœªæ‰¾åˆ°é¢„æœŸçš„è¿è¡Œæ—¶"

      - name: Build Flatpak package
        id: build
        run: |
          echo "ğŸ”¨ æ„å»º Flatpak åŒ… (GNOME ${{ matrix.gnome-version }})..."
          
          cd flatpak
          
          # æ›´æ–°é…ç½®æ–‡ä»¶ä¸­çš„è¿è¡Œæ—¶ç‰ˆæœ¬
          echo "ğŸ”§ æ›´æ–°è¿è¡Œæ—¶ç‰ˆæœ¬åˆ° ${{ matrix.gnome-version }}..."
          sed -i "s/runtime-version: '47'/runtime-version: '${{ matrix.gnome-version }}'/" com.influxdb.studio.yml
          
          # æ£€æŸ¥æ„å»ºç¯å¢ƒ
          echo "ğŸ“‹ æ„å»ºç¯å¢ƒæ£€æŸ¥ï¼š"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          echo "Flatpak è¿è¡Œæ—¶åˆ—è¡¨:"
          flatpak list --runtime | grep -E "(Platform|Sdk)" || echo "âš ï¸  æœªæ‰¾åˆ°è¿è¡Œæ—¶"
          
          # æ„å»º Flatpak åŒ…
          echo "ğŸ”¨ å¼€å§‹æ„å»º..."
          flatpak-builder --force-clean --repo=repo build com.influxdb.studio.yml
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ -d "build" ]; then
            echo "âœ… æ„å»ºç›®å½•åˆ›å»ºæˆåŠŸ"
          else
            echo "âŒ æ„å»ºç›®å½•åˆ›å»ºå¤±è´¥"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # åˆ›å»ºåŒ…æ–‡ä»¶
          echo "ğŸ“¦ åˆ›å»º Flatpak åŒ…æ–‡ä»¶..."
          flatpak build-bundle repo influxdb-studio-gnome${{ matrix.gnome-version }}.flatpak com.influxdb.studio
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ -f "influxdb-studio-gnome${{ matrix.gnome-version }}.flatpak" ]; then
            echo "âœ… æ„å»ºæˆåŠŸï¼"
            ls -lh influxdb-studio-gnome${{ matrix.gnome-version }}.flatpak
            echo "size=$(ls -lh influxdb-studio-gnome${{ matrix.gnome-version }}.flatpak | awk '{print $5}')" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          cd ..

      - name: Test Flatpak package
        if: steps.build.outputs.success == 'true'
        run: |
          echo "ğŸ§ª æµ‹è¯• Flatpak åŒ…..."
          
          cd flatpak
          
          # å®‰è£…åŒ…è¿›è¡Œæµ‹è¯•
          flatpak install --user influxdb-studio-gnome${{ matrix.gnome-version }}.flatpak -y
          
          # æ£€æŸ¥åº”ç”¨æ˜¯å¦å¯ä»¥å¯åŠ¨ï¼ˆéäº¤äº’å¼æµ‹è¯•ï¼‰
          if flatpak run com.influxdb.studio --help &> /dev/null || flatpak run com.influxdb.studio --version &> /dev/null; then
            echo "âœ… åº”ç”¨æµ‹è¯•é€šè¿‡"
          else
            echo "âš ï¸  åº”ç”¨å¯åŠ¨æµ‹è¯•å¤±è´¥ï¼Œä½†åŒ…å®‰è£…æˆåŠŸ"
          fi
          
          # å¸è½½æµ‹è¯•åŒ…
          flatpak uninstall com.influxdb.studio -y
          
          cd ..

      - name: Upload Flatpak package
        if: steps.build.outputs.success == 'true' && startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: influxdb-studio-gnome${{ matrix.gnome-version }}
          path: flatpak/influxdb-studio-gnome${{ matrix.gnome-version }}.flatpak
          retention-days: 30

      - name: Upload to Release
        if: steps.build.outputs.success == 'true' && startsWith(github.ref, 'refs/tags/')
        run: |
          echo "ğŸ“¤ ä¸Šä¼ åˆ° Release..."
          gh release upload ${{ github.ref_name }} flatpak/influxdb-studio-gnome${{ matrix.gnome-version }}.flatpak --repo ${{ github.repository }}
          echo "âœ… ä¸Šä¼ æˆåŠŸï¼"

      - name: Build Summary
        if: always()
        run: |
          echo "ğŸ“Š æ„å»ºæ€»ç»“ (GNOME ${{ matrix.gnome-version }})"
          echo "æ„å»ºçŠ¶æ€: ${{ steps.build.outputs.success }}"
          if [ "${{ steps.build.outputs.success }}" = "true" ]; then
            echo "åŒ…å¤§å°: ${{ steps.build.outputs.size }}"
            echo "âœ… æ„å»ºæˆåŠŸ"
          else
            echo "âŒ æ„å»ºå¤±è´¥"
          fi

  # é€‰æ‹©æœ€ä½³ç‰ˆæœ¬ä½œä¸ºä¸»è¦å‘å¸ƒ
  select-best-version:
    needs: flatpak-build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Select best version
        run: |
          echo "ğŸ¯ é€‰æ‹©æœ€ä½³ç‰ˆæœ¬..."
          
          # æŸ¥æ‰¾æ‰€æœ‰æ„å»ºæˆåŠŸçš„åŒ…
          find artifacts -name "*.flatpak" -type f | while read file; do
            echo "æ‰¾åˆ°åŒ…: $file"
            ls -lh "$file"
          done
          
          # é€‰æ‹©æœ€æ–°çš„ GNOME ç‰ˆæœ¬ä½œä¸ºä¸»è¦å‘å¸ƒ
          BEST_PACKAGE=$(find artifacts -name "*.flatpak" -type f | sort -V | tail -1)
          
          if [ -n "$BEST_PACKAGE" ]; then
            echo "é€‰æ‹©æœ€ä½³åŒ…: $BEST_PACKAGE"
            cp "$BEST_PACKAGE" influxdb-studio.flatpak
            echo "âœ… æœ€ä½³ç‰ˆæœ¬å·²å‡†å¤‡å°±ç»ª"
          else
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„åŒ…"
            exit 1
          fi

      - name: Upload best version to Release
        run: |
          echo "ğŸ“¤ ä¸Šä¼ æœ€ä½³ç‰ˆæœ¬åˆ° Release..."
          gh release upload ${{ github.ref_name }} influxdb-studio.flatpak --repo ${{ github.repository }}
          echo "âœ… æœ€ä½³ç‰ˆæœ¬ä¸Šä¼ æˆåŠŸï¼" 